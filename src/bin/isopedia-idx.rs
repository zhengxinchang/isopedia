use std::{env, path::PathBuf};

use clap::Parser;
use isopedia::{bptree::BPTree, chromosome::ChromMapping, constants::*, tmpidx::Tmpindex};
use log::{error, info};
use serde::Serialize;



#[derive(Parser, Debug, Serialize)]
#[command(name = "isopedia-aggr")]
#[command(author = "Xinchang Zheng <zhengxc93@gmail.com>")]
#[command(version = "0.1.0")]
#[command(about = "
Contact: Xinchang Zheng <zhengxc93@gmail.com>
", long_about = None)]
#[clap(after_long_help = "
")]
struct Cli {
    #[arg(
        short,
        long,
        help = "Index directory that generated by the aggr step."
    )]
    pub idxdir: PathBuf,

}

impl Cli {
    fn validate(&self) {
        let mut is_ok = true;
        if !self.idxdir.exists() {
            error!(
                "--idxdir: index directory {} does not exist",
                self.idxdir.display()
            );
            is_ok =  false;
        }

        if !self.idxdir.join(MERGED_FILE_NAME).exists() {
            error!(
                "--idxdir: Aggr file {} does not exist in {}",
                MERGED_FILE_NAME,
                self.idxdir.display()
            );
            is_ok = false;
        }

        if is_ok != true {
            // error!("Please check the input arguments!");
            std::process::exit(1);
        }

    }
}


fn greetings(args: &Cli) {
    println!("\nIsopedia: [Indexing merged isoform signals]\n");
    match serde_json::to_string_pretty(&args) {
        Ok(json) => println!("Parsed arguments:\n{}", json),
        Err(e) => eprintln!("Failed to print arguments: {}", e),
    }
}


fn main(){

    env::set_var("RUST_LOG", "info");
    env_logger::init();

    let cli = Cli::parse();
    cli.validate();
    greetings(&cli);

    let chrom_bytes = std::fs::read(cli.idxdir.join(CHROM_FILE_NAME)).expect("Cannot read chrom map file");

    let chrom_map = ChromMapping::decode(&chrom_bytes);


    let mut tmpidx = Tmpindex::load(&cli.idxdir.join(TMPIDX_FILE_NAME));

    for chrom_id  in chrom_map.get_chrom_idxs(){
        let blocks = tmpidx.get_blocks(chrom_id);
        if blocks.len() == 0{
            continue;
        }
        BPTree::build_tree(blocks, &cli.idxdir, chrom_id);
    }

    info!("Finished!");

}